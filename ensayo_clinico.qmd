---
title: "Creaci√≥n de base de datos y exportaci√≥n a Excel"
subtitle: "Bioestad√≠stica"
author: 
  - name: "Fabrizio Flores"
  - name: "Julia Sagastegui"
institute: "Profesor: Dr. Antonio M Quispe"
format: html
editor: visual
---

## üöÄ Reto

Crear la base de datos de un **ensayo cl√≠nico aleatorizado** dise√±ado para evaluar en **1000 individuos** la eficacia de una dieta para bajar de peso.

El estudio considera:

-   **Desenlace principal:** p√©rdida de peso (rango: -20 a +20 kg).
-   **Exposici√≥n:** dieta (0 = no expuestos, 1 = expuestos).
-   **Confusores:**
    -   Edad (18 a 60 a√±os, con distribuci√≥n de edad de la poblaci√≥n peruana).
    -   G√©nero (0 = femenino, 1 = masculino).
    -   Actividad f√≠sica, medida como frecuencia cardiaca en fase 2 (rango: 70 a 150).
    -   Nivel socioecon√≥mico (0 = A, 1 = B, 2 = C, 3 = D, 4 = E, con distribuci√≥n del NSE de la poblaci√≥n peruana).

------------------------------------------------------------------------

## üéØ Objetivo

En este tutorial aprender√°s a **simular un conjunto de datos ficticio** (1000 observaciones) y a **exportarlo a Excel** con dos hojas:

-   **Datos**: con las variables simuladas
-   **Metadata**: con la descripci√≥n de cada variable

------------------------------------------------------------------------

## üì¶ Cargar librer√≠as

```{r}
# Instalar solo una vez (desde consola, no en este script):
# install.packages(c("truncnorm", "openxlsx"))

library(truncnorm)  # Para simulaci√≥n con distribuci√≥n normal truncada
library(openxlsx)   # Para crear Excel con formato

```

------------------------------------------------------------------------

## üî¢ Simulaci√≥n de variables

```{r}
set.seed(123) # Reproducibilidad
n <- 1000     # N√∫mero de observaciones

# ID
ID <- 1:n

# Desenlace: p√©rdida de peso (kg) entre -20 y 20
Y <- round(rtruncnorm(n, a = -20, b = 20, mean = 0, sd = 5))

# Dieta (0/1 con probabilidad 0.5)
X1 <- rbinom(n, 1, 0.5)

# G√©nero (0=Femenino, 1=Masculino)
X2 <- rbinom(n, 1, 0.5)

# Edad (18‚Äì60, con m√°s densidad entre 20‚Äì39)
X3 <- sample(18:60, n, replace = TRUE,
             prob = c(rep(0.5,2),   # 18‚Äì19
                      rep(2.0,10),  # 20‚Äì29
                      rep(1.8,10),  # 30‚Äì39
                      rep(1.0,10),  # 40‚Äì49
                      rep(0.6,11))) # 50‚Äì60

# Frecuencia cardiaca (70‚Äì150 lpm, media=127.5, sd=6)
X4 <- round(rtruncnorm(n, a = 70, b = 150, mean = 127.5, sd = 6))

# Ingresos (categor√≠a socioecon√≥mica A‚ÄìE, con C y D m√°s frecuentes)
X5 <- sample(0:4, n, replace = TRUE, prob = c(0.05,0.10,0.40,0.30,0.15))

# Dataset final
df <- data.frame(ID, Y, X1, X2, X3, X4, X5)

# Vista preliminar
head(df)

```

------------------------------------------------------------------------

## üìù Metadata de las variables

```{r}
metadata <- data.frame(
  Variables = c("ID", "Y", "X1", "X2", "X3", "X4", "X5"),
  
  Etiqueta = c("Identificador √∫nico","P√©rdida de peso","Dieta","G√©nero","Edad","Frecuencia cardiaca","Ingresos econ√≥micos"),
  
  Tipo = c("Integer","Integer","Binary","Binary","Integer","Integer","Ordinal"),
  
  Valores_permitidos = c("1‚Äì1000 (√∫nico)","-20 a +20 (kg)","0=No,1=S√≠","0=F,1=M","18‚Äì60","70‚Äì150 (lpm)","0=A,1=B,2=C,3=D,4=E"),
  
  Unidades = c("N/A","kg","N/A","N/A","a√±os","latidos/minuto","Categor√≠a"),
  
  Origen = c("Asignado secuencialmente","Normal truncada","Aleatorio p=0.5","Aleatorio p=0.5","Muestreo ponderado","Normal truncada media=127.5","Distribuci√≥n socioecon√≥mica Per√∫"),
  
  Rol = c("Identificador","Variable de desenlace","Exposici√≥n","Covariable","Covariable","Covariable fisiol√≥gica","Covariable socioecon√≥mica"),
  
  stringsAsFactors = FALSE
)

metadata

```

------------------------------------------------------------------------

## üìä Exportar a Excel

```{r}
# Crear workbook
wb <- createWorkbook()

# Estilo encabezados
header_style <- createStyle(
  fontSize = 12, fontColour = "white", fgFill = "#4F81BD",
  halign = "center", textDecoration = "bold", border = "Bottom"
)

# Estilo cuerpo
body_style <- createStyle(fontSize = 10, border = "TopBottomLeftRight")

# Hoja de datos
addWorksheet(wb, "Datos")
writeData(wb, "Datos", df, headerStyle = header_style)
addStyle(wb, "Datos", body_style, rows = 2:(n+1), cols = 1:ncol(df), gridExpand = TRUE)
setColWidths(wb, "Datos", cols = 1:ncol(df), widths = "auto")

# Hoja de metadata
addWorksheet(wb, "Metadata")
writeData(wb, "Metadata", metadata, headerStyle = header_style)
addStyle(wb, "Metadata", body_style, rows = 2:(nrow(metadata)+1), cols = 1:ncol(metadata), gridExpand = TRUE)
setColWidths(wb, "Metadata", cols = 1:ncol(metadata), widths = "auto")

# Guardar archivo
outfile <- file.path(getwd(), "simulated.xlsx")
if (file.exists(outfile)) unlink(outfile)
saveWorkbook(wb, outfile, overwrite = TRUE)

message("‚úÖ Archivo Excel guardado en: ", outfile)

```
